# lab1 实验报告
学号 PB20081594 姓名 孙晨阳
## 实验要求
从无到有完成一个完整的Cminus-f解析器，包括基于flex的词法分析器和基于bison的语法分析器
### 基于flex的词法分析器
根据Cminus-f词法补全lexical_analyzer.l中的模式和动作并维护正确的token和text
### 基于bison的语法分析器
根据基础知识中给出的文法填写相应规则，完成语法分析树的构建
## 实验难点
### 一、理解实验要做什么
这个实验虽然有着实验要求，但是还是总觉得目标不够清晰，不知道自己在做什么。现在回过头来，才明白为什么自己做实验的时候总是很慢总是容易出bug。
这个实验分为两部分，第一部分为分词，即通过flex的match规则，准确识别并分类出各种各样的词。第二部分为构建语法分析树，这部分由三处需要修改，一为语法分析树节点的类型，二为token类别，三为写出语法分析的产生式。
现在回过头来，觉得实验文档写的十分的清晰明了，但是在刚写的时候，却表示完全看不懂。
觉得此实验用一种层次化的思想来做，首先就是明白从宏观上自己要做什么，而不是一开始直接看各种各样的资料，之后再慢慢细化，现用现查要用的资料。而不是像在一开始那样，看各种知识点，最终连自己要做什么都不清楚。
### 二、理解flex和bison的运行机制
针对我们要修改的部分，首先是flex的模式+动作。首先**什么是模式**，模式就是自己定义的能够匹配相应字符串的规则。由于flex是分词，所以你要定义一系列的模式，对于给定的任意字符串全部都能够分解，不能存在未被分解的字符串。而在实验基础知识的这里
![cifa|400](./cifa.png)
就会明白该如何进行分词，分词的种类有哪些。之后具体的操作就依据[[Flex-regular-expressions]]即可。对于动作而言仿照示例即可。
对于bison要构建一个语法分析树，重点在于理解bison是怎样运行的。对于分析树的每一个节点，它们的节点类型是未定义的，因此需要定义一个节点类型。然后就是分析树的分支节点和叶子节点是两种不同的节点，这个不同体现在，叶子节点是经由flex分词产生的词法种类（即终结符），而分支节点是定义在bison中的非终结符。因此bison要写的部分的框架已经清晰明了了，首先是定义分析树节点的数据类型，然后是定义分析树节点的名称，最后是补充分析树的分支规则（产生式）。
### 三、学会flex和bison的写法
flex的写法在于模式+动作，根据示例即为 
```
Flex-regular-expressions { action1 ;action2;... }
```
这里比较难的点就是**注释**的正则表达式匹配，其在文档中并没有任何提示，只能自己写。
bison中的写法内容首先是定义token，仿照示例还是比较容易写出来的，但是并不能理解为什么要这样写。比如，
```
%token <node> TOKEN_NAME
```
我可能会认为这是定义一个token时固定的写法，对于文档中的提示补充，我也认为可能只有当union定义了多个类型时才需要指定类型（但实际即便union里面只有一种数据类型时也需要指定）。
还有一点给我造成了巨大困惑的是，\$\$, \$1,...难以理解，而且个人觉得实验文档中关于这一点的提示并没有很明了~~个人觉得关键原因是我们初次接触这种\$符号，不是很能理解它所起到的类似指针的作用~~。不过最后还是明白了，\$\$代表产生式的条件的节点，\$1代表产生式的结果从左数第一个， ... 。
### 四、报错定位难
比如union的数据类型未定义，但是报错的位置确实在lexical_analyzer.l文件里面。
比如syntax error的错误可能是由于语法错误，也可能是由于词法错误，但是最终报错都是syntax error，因此就只能一点点找，调试起来非常麻烦。
等等
## 实验设计
由于此实验由助教所设计，因此仅在此处阐述一下做实验的大致逻辑，且此处的陈述与前面的实验难点可能有部分重合
个人觉得原本应该是实验最难的一部分应当是这个分析树的框架，所幸这一部分由助教们完成了。
本次实验采用bison和flex结合。flex负责词法部分，通过学生所写的词法正则表达式，经过一系列设定好的操作，转换成可执行文件**a.out**。**a.out**通过获得输入流，将其转换为TOKEN_STREAM。同时词法的正则表达式定义了BISON中的TOKEN类型，根据已给定的语法分析和节点数据类型，构建一个完整的BISON语法分析工具。由yylex函数为BISON提供TOKEN，假如能够分析出正确的语法树，则输出语法树。否则则有yyerror函数引发syntax_error。
本次实验的大部分工作由助教编写和bison、flex两个包代替，极大地减轻了学生的工作量。
学生负责的部分为词法的匹配规则编写，语法分析树节点数据类型的定义，语法分析树节点的名称和数据类型选择，语法分析树的推导规则。
上述所说的实验设计思路可以简化为如下的实验设计图
![design](./design.png)
## 实验结果验证
### easy难度下脚本测试结果
![easy](./easy.png)
### normal难度下的脚本测试结果
![normal](./normal.png)
### hard难度下的脚本测试结果
![hard](./hard.png)
### 在线评测测试结果
![hard|600](./tests.png)
## 实验反馈
#### 1.\$\$, \$1, \$2...难以理解
觉得实验中这些符号即便给了范例但还是没有很清晰的理解他们到底表示什么意思
感觉在网上搜到的一个解释比较好，就是\$\$指代产生式左边的节点，\$1指代的是推导出来第一个节点，然后依次。
#### 2.对parser的理解感觉没有很强的加深
感觉只是在盲目的按照实验文档一步步填写，只是加深了对正则表达式还有flex，bison书写方式的了解。关键是由于flex，bison运行在幕后，我就不是很清楚它是怎样根据我的规则具体地一步步实现parser的，只知道我定义了这些规则，然后它就动了emmm
具体来讲就是在这样一个语法分析器的构建下，我只是机械性的完成了一小部分，对它的全貌完全不清楚。感觉这个实验更像是入门级别的。
觉得如果可以的话，可以更加侧重于flex，bison处理我给出的这些数据的方式。